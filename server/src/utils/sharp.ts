import sharp from "sharp";

const ACCEPTED_IMAGE_TYPES = [
  "image/jpg",
  "image/jpeg",
  "image/png",
  "image/webp",
];

const svgOverlay = `
      <svg width="120" height="20" viewBox="0 0 120 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="120" height="20" rx="5" fill="white" fill-opacity="0.5"/>
        <path d="M12.5398 9.21591V13H10.7244V6.45455H12.4545V7.60938H12.5312C12.6761 7.22869 12.919 6.92756 13.2599 6.70597C13.6009 6.48153 14.0142 6.36932 14.5 6.36932C14.9545 6.36932 15.3509 6.46875 15.6889 6.66761C16.027 6.86648 16.2898 7.15057 16.4773 7.51989C16.6648 7.88636 16.7585 8.32386 16.7585 8.83239V13H14.9432V9.15625C14.946 8.75568 14.8438 8.44318 14.6364 8.21875C14.429 7.99148 14.1435 7.87784 13.7798 7.87784C13.5355 7.87784 13.3196 7.9304 13.1321 8.03551C12.9474 8.14062 12.8026 8.29403 12.6974 8.49574C12.5952 8.6946 12.5426 8.93466 12.5398 9.21591ZM20.0558 13.1236C19.6381 13.1236 19.266 13.0511 18.9393 12.9062C18.6126 12.7585 18.354 12.5412 18.1637 12.2543C17.9762 11.9645 17.8825 11.6037 17.8825 11.1719C17.8825 10.8082 17.9492 10.5028 18.0827 10.2557C18.2163 10.0085 18.3981 9.80966 18.6282 9.65909C18.8583 9.50852 19.1197 9.39489 19.4123 9.31818C19.7077 9.24148 20.0174 9.1875 20.3413 9.15625C20.7219 9.11648 21.0288 9.07955 21.2617 9.04545C21.4947 9.00852 21.6637 8.95455 21.7688 8.88352C21.8739 8.8125 21.9265 8.70739 21.9265 8.56818V8.54261C21.9265 8.27273 21.8413 8.06392 21.6708 7.91619C21.5032 7.76847 21.2646 7.6946 20.9549 7.6946C20.6282 7.6946 20.3683 7.76705 20.1751 7.91193C19.9819 8.05398 19.854 8.23295 19.7915 8.44886L18.1126 8.3125C18.1978 7.91477 18.3654 7.57102 18.6154 7.28125C18.8654 6.98864 19.1879 6.7642 19.5827 6.60795C19.9805 6.44886 20.4407 6.36932 20.9634 6.36932C21.3271 6.36932 21.6751 6.41193 22.0075 6.49716C22.3427 6.58239 22.6396 6.71449 22.8981 6.89347C23.1594 7.07244 23.3654 7.30256 23.516 7.58381C23.6665 7.86222 23.7418 8.19602 23.7418 8.58523V13H22.0202V12.0923H21.9691C21.864 12.2969 21.7234 12.4773 21.5472 12.6335C21.3711 12.7869 21.1594 12.9077 20.9123 12.9957C20.6651 13.081 20.3796 13.1236 20.0558 13.1236ZM20.5756 11.8707C20.8427 11.8707 21.0785 11.8182 21.283 11.7131C21.4876 11.6051 21.6481 11.4602 21.7646 11.2784C21.881 11.0966 21.9393 10.8906 21.9393 10.6605V9.96591C21.8825 10.0028 21.8043 10.0369 21.7049 10.0682C21.6083 10.0966 21.4989 10.1236 21.3768 10.1491C21.2546 10.1719 21.1325 10.1932 21.0103 10.2131C20.8881 10.2301 20.7773 10.2457 20.6779 10.2599C20.4648 10.2912 20.2788 10.3409 20.1197 10.4091C19.9606 10.4773 19.837 10.5696 19.7489 10.6861C19.6609 10.7997 19.6168 10.9418 19.6168 11.1122C19.6168 11.3594 19.7063 11.5483 19.8853 11.679C20.0671 11.8068 20.2972 11.8707 20.5756 11.8707ZM28.0991 15.5909C27.511 15.5909 27.0067 15.5099 26.5863 15.348C26.1687 15.1889 25.8363 14.9716 25.5891 14.696C25.342 14.4205 25.1815 14.1108 25.1076 13.767L26.7866 13.5412C26.8377 13.6719 26.9187 13.794 27.0295 13.9077C27.1403 14.0213 27.2866 14.1122 27.4684 14.1804C27.6531 14.2514 27.8775 14.2869 28.1417 14.2869C28.5366 14.2869 28.8619 14.1903 29.1175 13.9972C29.3761 13.8068 29.5053 13.4872 29.5053 13.0384V11.8409H29.4286C29.3491 12.0227 29.2298 12.1946 29.0707 12.3565C28.9116 12.5185 28.707 12.6506 28.457 12.7528C28.207 12.8551 27.9087 12.9062 27.5621 12.9062C27.0707 12.9062 26.6232 12.7926 26.2198 12.5653C25.8192 12.3352 25.4996 11.9844 25.261 11.5128C25.0252 11.0384 24.9073 10.4389 24.9073 9.71449C24.9073 8.97301 25.0281 8.35369 25.2695 7.85653C25.511 7.35937 25.832 6.98722 26.2326 6.74006C26.636 6.4929 27.0778 6.36932 27.5579 6.36932C27.9244 6.36932 28.2312 6.43182 28.4783 6.55682C28.7255 6.67898 28.9244 6.83239 29.0749 7.01705C29.2283 7.19886 29.3462 7.37784 29.4286 7.55398H29.4968V6.45455H31.2994V13.0639C31.2994 13.6207 31.163 14.0866 30.8903 14.4616C30.6175 14.8366 30.2397 15.1179 29.7567 15.3054C29.2766 15.4957 28.7241 15.5909 28.0991 15.5909ZM28.1374 11.5426C28.43 11.5426 28.6772 11.4702 28.8789 11.3253C29.0835 11.1776 29.2397 10.9673 29.3477 10.6946C29.4585 10.419 29.5138 10.0895 29.5138 9.70597C29.5138 9.32244 29.4599 8.99006 29.3519 8.70881C29.244 8.42472 29.0877 8.20455 28.8832 8.0483C28.6786 7.89205 28.43 7.81392 28.1374 7.81392C27.8391 7.81392 27.5877 7.89489 27.3832 8.05682C27.1786 8.21591 27.0238 8.4375 26.9187 8.72159C26.8136 9.00568 26.761 9.33381 26.761 9.70597C26.761 10.0838 26.8136 10.4105 26.9187 10.6861C27.0266 10.9588 27.1815 11.1705 27.3832 11.321C27.5877 11.4687 27.8391 11.5426 28.1374 11.5426ZM32.744 15.4545V6.45455H34.5337V7.55398H34.6147C34.6942 7.37784 34.8093 7.19886 34.9599 7.01705C35.1133 6.83239 35.3121 6.67898 35.5565 6.55682C35.8036 6.43182 36.1104 6.36932 36.4769 6.36932C36.9542 6.36932 37.3945 6.49432 37.7979 6.74432C38.2013 6.99148 38.5238 7.36506 38.7653 7.86506C39.0067 8.36222 39.1275 8.9858 39.1275 9.7358C39.1275 10.4659 39.0096 11.0824 38.7738 11.5852C38.5408 12.0852 38.2227 12.4645 37.8192 12.723C37.4187 12.9787 36.9698 13.1065 36.4727 13.1065C36.1204 13.1065 35.8207 13.0483 35.5735 12.9318C35.3292 12.8153 35.1289 12.669 34.9727 12.4929C34.8164 12.3139 34.6971 12.1335 34.6147 11.9517H34.5593V15.4545H32.744ZM34.521 9.72727C34.521 10.1165 34.5749 10.456 34.6829 10.7457C34.7908 11.0355 34.9471 11.2614 35.1516 11.4233C35.3562 11.5824 35.6048 11.6619 35.8974 11.6619C36.1928 11.6619 36.4428 11.581 36.6474 11.419C36.8519 11.2543 37.0067 11.027 37.1119 10.7372C37.2198 10.4446 37.2738 10.108 37.2738 9.72727C37.2738 9.34943 37.2212 9.01705 37.1161 8.73011C37.011 8.44318 36.8562 8.21875 36.6516 8.05682C36.4471 7.89489 36.1957 7.81392 35.8974 7.81392C35.6019 7.81392 35.3519 7.89205 35.1474 8.0483C34.9457 8.20455 34.7908 8.42614 34.6829 8.71307C34.5749 9 34.521 9.33807 34.521 9.72727ZM44.5352 10.2131V6.45455H46.3505V13H44.6076V11.8111H44.5394C44.3917 12.1946 44.146 12.5028 43.8022 12.7358C43.4613 12.9687 43.0451 13.0852 42.5536 13.0852C42.1161 13.0852 41.7312 12.9858 41.3988 12.7869C41.0664 12.5881 40.8065 12.3054 40.619 11.9389C40.4343 11.5724 40.3406 11.1335 40.3377 10.6222V6.45455H42.1531V10.2983C42.1559 10.6847 42.2596 10.9901 42.4641 11.2145C42.6687 11.4389 42.9428 11.5511 43.2866 11.5511C43.5053 11.5511 43.7099 11.5014 43.9002 11.402C44.0906 11.2997 44.244 11.1491 44.3604 10.9503C44.4798 10.7514 44.538 10.5057 44.5352 10.2131ZM47.8026 13V6.45455H49.5625V7.59659H49.6307C49.75 7.19034 49.9503 6.88352 50.2315 6.67614C50.5128 6.46591 50.8366 6.3608 51.2031 6.3608C51.294 6.3608 51.392 6.36648 51.4972 6.37784C51.6023 6.3892 51.6946 6.40483 51.7741 6.42472V8.03551C51.6889 8.00994 51.571 7.98722 51.4205 7.96733C51.2699 7.94744 51.1321 7.9375 51.0071 7.9375C50.7401 7.9375 50.5014 7.99574 50.2912 8.11222C50.0838 8.22585 49.919 8.38494 49.7969 8.58949C49.6776 8.79403 49.6179 9.02983 49.6179 9.29688V13H47.8026ZM54.5281 9.21591V13H52.7127V6.45455H54.4428V7.60938H54.5195C54.6644 7.22869 54.9073 6.92756 55.2482 6.70597C55.5891 6.48153 56.0025 6.36932 56.4883 6.36932C56.9428 6.36932 57.3391 6.46875 57.6772 6.66761C58.0153 6.86648 58.2781 7.15057 58.4656 7.51989C58.6531 7.88636 58.7468 8.32386 58.7468 8.83239V13H56.9315V9.15625C56.9343 8.75568 56.832 8.44318 56.6246 8.21875C56.4173 7.99148 56.1317 7.87784 55.7681 7.87784C55.5238 7.87784 55.3079 7.9304 55.1204 8.03551C54.9357 8.14062 54.7908 8.29403 54.6857 8.49574C54.5835 8.6946 54.5309 8.93466 54.5281 9.21591ZM63.1605 13.1278C62.4872 13.1278 61.9077 12.9915 61.4219 12.7188C60.9389 12.4432 60.5668 12.054 60.3054 11.5511C60.044 11.0455 59.9134 10.4474 59.9134 9.7571C59.9134 9.08381 60.044 8.4929 60.3054 7.98438C60.5668 7.47585 60.9347 7.07955 61.4091 6.79545C61.8864 6.51136 62.446 6.36932 63.0881 6.36932C63.5199 6.36932 63.9219 6.43892 64.294 6.57812C64.669 6.71449 64.9957 6.92045 65.2741 7.19602C65.5554 7.47159 65.7741 7.81818 65.9304 8.2358C66.0866 8.65057 66.1648 9.13636 66.1648 9.69318V10.1918H60.6378V9.06676H64.456C64.456 8.8054 64.3991 8.57386 64.2855 8.37216C64.1719 8.17045 64.0142 8.01278 63.8125 7.89915C63.6136 7.78267 63.3821 7.72443 63.1179 7.72443C62.8423 7.72443 62.598 7.78835 62.3849 7.91619C62.1747 8.04119 62.0099 8.21023 61.8906 8.4233C61.7713 8.63352 61.7102 8.8679 61.7074 9.12642V10.196C61.7074 10.5199 61.767 10.7997 61.8864 11.0355C62.0085 11.2713 62.1804 11.4531 62.402 11.581C62.6236 11.7088 62.8864 11.7727 63.1903 11.7727C63.392 11.7727 63.5767 11.7443 63.7443 11.6875C63.9119 11.6307 64.0554 11.5455 64.1747 11.4318C64.294 11.3182 64.3849 11.179 64.4474 11.0142L66.1264 11.125C66.0412 11.5284 65.8665 11.8807 65.6023 12.1818C65.3409 12.4801 65.0028 12.7131 64.5881 12.8807C64.1761 13.0455 63.7003 13.1278 63.1605 13.1278ZM68.5938 13L66.8125 6.45455H68.6491L69.6634 10.8523H69.723L70.7798 6.45455H72.5824L73.6562 10.8267H73.7116L74.7088 6.45455H76.5412L74.7642 13H72.8423L71.7173 8.88352H71.6364L70.5114 13H68.5938ZM82.9556 8.32102L81.2937 8.4233C81.2653 8.28125 81.2042 8.15341 81.1104 8.03977C81.0167 7.9233 80.8931 7.83097 80.7397 7.76278C80.5891 7.69176 80.4087 7.65625 80.1985 7.65625C79.9173 7.65625 79.68 7.71591 79.4869 7.83523C79.2937 7.9517 79.1971 8.10795 79.1971 8.30398C79.1971 8.46023 79.2596 8.59233 79.3846 8.70028C79.5096 8.80824 79.7241 8.89489 80.0281 8.96023L81.2127 9.19886C81.8491 9.32955 82.3235 9.53977 82.636 9.82955C82.9485 10.1193 83.1048 10.5 83.1048 10.9716C83.1048 11.4006 82.9783 11.777 82.7255 12.1009C82.4755 12.4247 82.1317 12.6776 81.6942 12.8594C81.2596 13.0384 80.7582 13.1278 80.19 13.1278C79.3235 13.1278 78.6332 12.9474 78.119 12.5866C77.6076 12.223 77.3079 11.7287 77.2198 11.1037L79.0053 11.0099C79.0593 11.2741 79.19 11.4759 79.3974 11.6151C79.6048 11.7514 79.8704 11.8196 80.1942 11.8196C80.5124 11.8196 80.7681 11.7585 80.9613 11.6364C81.1573 11.5114 81.2567 11.3509 81.2596 11.1548C81.2567 10.9901 81.1871 10.8551 81.0508 10.75C80.9144 10.642 80.7042 10.5597 80.4201 10.5028L79.2866 10.277C78.6474 10.1491 78.1715 9.92756 77.859 9.61222C77.5494 9.29687 77.3945 8.89489 77.3945 8.40625C77.3945 7.9858 77.5082 7.62358 77.7354 7.3196C77.9656 7.01562 78.288 6.78125 78.7028 6.61648C79.1204 6.4517 79.609 6.36932 80.1687 6.36932C80.9954 6.36932 81.646 6.54403 82.1204 6.89347C82.5977 7.2429 82.8761 7.71875 82.9556 8.32102ZM85.3089 13.1108C85.0277 13.1108 84.7862 13.0114 84.5845 12.8125C84.3857 12.6108 84.2862 12.3693 84.2862 12.0881C84.2862 11.8097 84.3857 11.571 84.5845 11.3722C84.7862 11.1733 85.0277 11.0739 85.3089 11.0739C85.5817 11.0739 85.8203 11.1733 86.0249 11.3722C86.2294 11.571 86.3317 11.8097 86.3317 12.0881C86.3317 12.2756 86.2834 12.4474 86.1868 12.6037C86.093 12.7571 85.9695 12.8807 85.8161 12.9744C85.6626 13.0653 85.4936 13.1108 85.3089 13.1108ZM89.6374 4.27273V13H87.8221V4.27273H89.6374ZM91.0916 13V6.45455H92.907V13H91.0916ZM92.0036 5.6108C91.7337 5.6108 91.5021 5.52131 91.3089 5.34233C91.1186 5.16051 91.0234 4.94318 91.0234 4.69034C91.0234 4.44034 91.1186 4.22585 91.3089 4.04688C91.5021 3.86506 91.7337 3.77415 92.0036 3.77415C92.2734 3.77415 92.5036 3.86506 92.6939 4.04688C92.8871 4.22585 92.9837 4.44034 92.9837 4.69034C92.9837 4.94318 92.8871 5.16051 92.6939 5.34233C92.5036 5.52131 92.2734 5.6108 92.0036 5.6108ZM100.463 6.45455L98.1751 13H96.1296L93.8413 6.45455H95.7589L97.1183 11.1378H97.1864L98.5415 6.45455H100.463ZM104.164 13.1278C103.491 13.1278 102.912 12.9915 102.426 12.7188C101.943 12.4432 101.571 12.054 101.309 11.5511C101.048 11.0455 100.917 10.4474 100.917 9.7571C100.917 9.08381 101.048 8.4929 101.309 7.98438C101.571 7.47585 101.939 7.07955 102.413 6.79545C102.89 6.51136 103.45 6.36932 104.092 6.36932C104.524 6.36932 104.926 6.43892 105.298 6.57812C105.673 6.71449 106 6.92045 106.278 7.19602C106.559 7.47159 106.778 7.81818 106.934 8.2358C107.091 8.65057 107.169 9.13636 107.169 9.69318V10.1918H101.642V9.06676H105.46C105.46 8.8054 105.403 8.57386 105.289 8.37216C105.176 8.17045 105.018 8.01278 104.816 7.89915C104.618 7.78267 104.386 7.72443 104.122 7.72443C103.846 7.72443 103.602 7.78835 103.389 7.91619C103.179 8.04119 103.014 8.21023 102.895 8.4233C102.775 8.63352 102.714 8.8679 102.711 9.12642V10.196C102.711 10.5199 102.771 10.7997 102.89 11.0355C103.012 11.2713 103.184 11.4531 103.406 11.581C103.627 11.7088 103.89 11.7727 104.194 11.7727C104.396 11.7727 104.581 11.7443 104.748 11.6875C104.916 11.6307 105.059 11.5455 105.179 11.4318C105.298 11.3182 105.389 11.179 105.451 11.0142L107.13 11.125C107.045 11.5284 106.87 11.8807 106.606 12.1818C106.345 12.4801 106.007 12.7131 105.592 12.8807C105.18 13.0455 104.704 13.1278 104.164 13.1278Z" fill="black"/>
      </svg>
    `;

export const watermarkImage = async (file: Express.Multer.File) => {
  try {
    let watermarkedImage = null;
    if (ACCEPTED_IMAGE_TYPES.includes(file.mimetype)) {
      watermarkedImage = await sharp(file.buffer)
        .composite([
          {
            input: Buffer.from(svgOverlay),
            gravity: "northwest",
          },
        ])
        .toBuffer();
    }
    return watermarkedImage;
  } catch (err) {
    console.log(err);
    throw new Error("Error processing image");
  }
};
